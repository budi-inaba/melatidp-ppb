<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PPB - Pendaftaran</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <nav class="bg-white shadow-md border-b-4 border-blue-600 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex flex-col items-center gap-1">
            <div class="h-10 flex items-center justify-center">
                <img src="logo-rptra.png" alt="Logo RPTRA" class="h-full w-auto object-contain" onerror="this.src='https://placehold.co/120x40/f3f4f6/3b82f6?text=LOGO+RPTRA';">
            </div>
            <div class="flex flex-col items-center text-center">
                <span class="font-extrabold text-xl tracking-tight text-blue-900 leading-tight">Sistem PPB Terpadu</span>
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">RPTRA Melati Duri Pulo</span>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- VIEW: PENDAFTARAN -->
        <div id="view-form" class="fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-gray-900">Formulir Pendaftaran</h1>
                    <p class="text-gray-500 text-sm">Program Pangan Bersubsidi</p>
                </div>

                <form id="form-pendaftaran" class="space-y-6" onsubmit="handlePendaftaran(event)">
                    <div class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h2 class="font-bold flex items-center gap-2 text-blue-600 border-b pb-2 text-sm uppercase">
                            <i data-lucide="user" class="w-4 h-4"></i> Informasi Identitas
                        </h2>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kelurahan Sesuai KK</label>
                            <input type="text" id="kelurahan" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama kelurahan">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. Kartu Keluarga (Harus 16 Digit)</label>
                            <input type="number" id="no_kk" required oninput="limitDigits(this, 16)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="317101XXXXXXXXXX">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Nama Pengisi Form</label>
                            <input type="text" id="nama_pengisi" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama lengkap">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. KTP (Harus 16 Digit)</label>
                            <input type="number" id="nik" required oninput="limitDigits(this, 16)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="317101XXXXXXXXXX">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Nama Pemilik Kartu ATM</label>
                            <input type="text" id="nama" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Sesuai nama di kartu">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. Kartu ATM (16 atau 18 Digit)</label>
                            <input type="number" id="no_atm" required oninput="limitDigits(this, 18)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="6013XXXXXXXXXXXX">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kategori Penerima</label>
                            <select id="kategori_penerima" onchange="renderProduk()" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="" disabled selected>Pilih Kategori</option>
                                <option value="KJP">KJP (Kartu Jakarta Pintar)</option>
                                <option value="PJLP">PJLP (Penyedia Jasa Lainnya Perorangan)</option>
                                <option value="Kartu Lansia">Kartu Lansia Jakarta (KLJ)</option>
                                <option value="Kartu Disabilitas">Kartu Penyandang Disabilitas Jakarta (KPDJ)</option>
                                <option value="Dasawisma">Dasawisma</option>
                                <option value="KAJ">KAJ (Kartu Anak Jakarta)</option>
                                <option value="Kartu Pekerja">Kartu Pekerja Jakarta (KPJ)</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h2 class="font-bold flex items-center gap-2 text-green-600 border-b pb-2 text-sm uppercase">
                            <i data-lucide="shopping-bag" class="w-4 h-4"></i> Jenis Komoditas
                        </h2>
                        <div id="container-produk" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 transition flex justify-center items-center gap-2 shadow-lg active:scale-95">
                        <i data-lucide="send" class="w-5 h-5"></i> Kirim Pendaftaran
                    </button>
                </form>
            </div>
        </div>

        <!-- VIEW: TIKET -->
        <div id="view-tiket" class="hidden fade-in max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 p-6 text-center border-b">
                    <img src="logo-rptra.png" alt="Logo RPTRA" class="h-8 w-auto mx-auto mb-2" onerror="this.src='https://placehold.co/80x30/f3f4f6/3b82f6?text=RPTRA';">
                    <h2 class="text-xl font-extrabold text-blue-900">Bukti Pendaftaran</h2>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">RPTRA Melati Duri Pulo</p>
                </div>
                
                <div class="p-6 text-center">
                    <div id="qrcode-container" class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100 flex justify-center"></div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mb-1 text-center">ID Transaksi</p>
                    <p id="tiket-id" class="text-3xl font-mono font-bold tracking-wider text-blue-700 mb-6 text-center">PPB-XXXX</p>
                    
                    <div class="text-left bg-gray-50 p-4 rounded-xl text-xs border border-gray-100 space-y-3 mb-6">
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Waktu Daftar</span> 
                            <span id="tiket-waktu" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Kelurahan</span> 
                            <span id="tiket-kelurahan" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">No. Kartu Keluarga</span> 
                            <span id="tiket-kk" class="font-bold font-mono text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Nama Pemilik Kartu ATM</span> 
                            <span id="tiket-nama" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Kategori Penerima</span> 
                            <span id="tiket-kategori" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Jenis Komoditas</span>
                            <div id="tiket-produk-list" class="flex flex-wrap gap-1 mt-1 font-bold text-blue-700 uppercase"></div>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Lokasi Pengambilan</span>
                            <div class="text-gray-800 leading-relaxed">
                                <p class="font-extrabold text-blue-900">RPTRA Melati Duri Pulo</p>
                                <p>Jl. Petojo Barat XI No. 5 RT. 012 RW. 001</p>
                                <p>Kelurahan Duri Pulo - Kecamatan Gambir</p>
                                <p>Jakarta Pusat</p>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md text-[10px] font-bold bg-yellow-100 text-yellow-800 w-fit">MENUNGGU VERIFIKASI</span>
                        </div>
                    </div>

                    <button onclick="resetForm()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition text-sm">
                        Kembali ke Beranda
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: VERIFIKASI ADMIN -->
        <div id="view-verifikasi" class="hidden fade-in max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 p-6">
                <h1 class="text-lg font-bold mb-6 text-center text-gray-800 flex flex-col items-center gap-2">
                    <img src="logo-rptra.png" alt="Logo RPTRA" class="h-8 w-auto mb-1" onerror="this.src='https://placehold.co/80x30/f3f4f6/3b82f6?text=RPTRA';">
                    <span class="text-blue-900">Verifikasi Pengambilan</span>
                </h1>

                <div id="verifikasi-data" class="hidden">
                    <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200 space-y-4 text-sm mb-6 relative overflow-hidden">
                        <div id="watermark-status" class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none text-3xl font-black rotate-[-30deg]"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col"><span class="text-gray-400 text-[10px] uppercase font-bold">ID Pesanan</span><span id="v-id" class="font-mono text-blue-700 font-bold"></span></div>
                            <div class="flex flex-col"><span class="text-gray-400 text-[10px] uppercase font-bold">Kategori</span><span id="v-kategori" class="font-bold"></span></div>
                        </div>
                        <div class="flex flex-col"><span class="text-gray-400 text-[10px] uppercase font-bold">Nama Pemilik ATM</span><span id="v-nama" class="font-bold text-gray-800 text-base"></span></div>
                        <div class="flex flex-col border-b pb-2"><span class="text-gray-400 text-[10px] uppercase font-bold">No. Kartu ATM</span><span id="v-no-atm" class="font-mono"></span></div>
                        <div id="v-produk" class="flex flex-wrap gap-2 pt-2"></div>
                    </div>

                    <button id="btn-approve" onclick="approvePesanan()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 transition shadow-lg">
                        Konfirmasi Penyerahan
                    </button>
                    <button onclick="window.location.href = window.location.pathname" class="w-full mt-4 text-gray-400 text-xs py-2">Batal</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        function validateLetters(input) {
            input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
        }

        function limitDigits(input, max) {
            if (input.value.length > max) {
                input.value = input.value.slice(0, max);
            }
        }

        const KOMODITAS_LIST = [
            { id: 'ayam', nama: 'Ayam 1 ekor', harga: 'Rp 8.000' },
            { id: 'daging', nama: 'Daging Sapi 1Kg', harga: 'Rp 35.000' },
            { id: 'telur', nama: 'Telur Ayam 1 Tray', harga: 'Rp 10.000' },
            { id: 'beras', nama: 'Beras Premium 5Kg', harga: 'Rp 30.000' },
            { id: 'ikan', nama: 'Ikan Kembung 1Kg', harga: 'Rp 13.000' },
            { id: 'susu', nama: 'Susu UHT 1 Karton', harga: 'Rp 30.000' },
        ];

        let pesananAktif = null;

        function initDB() {
            if (!localStorage.getItem('db_pesanan')) localStorage.setItem('db_pesanan', JSON.stringify([]));
        }

        function getPesanan() { return JSON.parse(localStorage.getItem('db_pesanan')); }
        function savePesanan(data) {
            const p = getPesanan();
            p.push(data);
            localStorage.setItem('db_pesanan', JSON.stringify(p));
        }
        function updateStatusPesanan(id, status) {
            const p = getPesanan();
            const idx = p.findIndex(x => x.id === id);
            if(idx !== -1) {
                p[idx].status = status;
                localStorage.setItem('db_pesanan', JSON.stringify(p));
            }
        }

        function renderProduk() {
            const container = document.getElementById('container-produk');
            const kategoriPenerima = document.getElementById('kategori_penerima').value;
            container.innerHTML = '';
            
            KOMODITAS_LIST.forEach(item => {
                if (item.id === 'susu' && kategoriPenerima && kategoriPenerima !== 'KJP') return;
                const div = document.createElement('div');
                div.className = `border-2 border-gray-100 rounded-xl p-4 flex items-center gap-4 transition bg-white hover:border-blue-400 cursor-pointer group`;
                div.innerHTML = `
                    <input type="checkbox" name="produk" value="${item.id}" class="w-5 h-5 rounded border-gray-300 text-blue-600">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800 text-sm group-hover:text-blue-700 transition uppercase">${item.nama}</p>
                        <p class="text-xs text-blue-500 font-bold">${item.harga}</p>
                    </div>`;
                div.onclick = (e) => { 
                    if(e.target.type !== 'checkbox') { 
                        const cb = div.querySelector('input'); 
                        cb.checked = !cb.checked; 
                    }
                };
                container.appendChild(div);
            });
        }

        function getFormattedDate() {
            const now = new Date();
            return now.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + 
                   now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace(/\./g, ':');
        }

        function handlePendaftaran(e) {
            e.preventDefault();
            const kel = document.getElementById('kelurahan').value;
            const nik = document.getElementById('nik').value;
            const no_kk = document.getElementById('no_kk').value;
            const nama = document.getElementById('nama').value;
            const no_atm = document.getElementById('no_atm').value;
            const kategori = document.getElementById('kategori_penerima').value;
            const nama_pengisi = document.getElementById('nama_pengisi').value;
            
            // Validasi Digit
            if (nik.length !== 16) return alert("No. KTP harus 16 digit.");
            if (no_kk.length !== 16) return alert("No. Kartu Keluarga harus 16 digit.");
            if (no_atm.length !== 16 && no_atm.length !== 18) return alert("No. Kartu ATM harus 16 atau 18 digit.");

            const prod = Array.from(document.querySelectorAll('input[name="produk"]:checked')).map(c => {
                return KOMODITAS_LIST.find(k => k.id === c.value).nama;
            });

            if(prod.length === 0) return alert("Pilih minimal 1 komoditas.");

            const id = `PPB-${Math.floor(1000 + Math.random() * 9000)}`;
            const waktuSekarang = getFormattedDate();
            
            savePesanan({ id, nik, no_kk, nama, no_atm, kategori, nama_pengisi, kelurahan: kel, produkNama: prod, status: 'Menunggu', waktu: waktuSekarang });

            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-tiket').classList.remove('hidden');
            
            // Render Data ke Tiket
            document.getElementById('tiket-id').textContent = id;
            document.getElementById('tiket-nama').textContent = nama;
            document.getElementById('tiket-kategori').textContent = kategori;
            document.getElementById('tiket-kk').textContent = no_kk;
            document.getElementById('tiket-kelurahan').textContent = kel;
            document.getElementById('tiket-waktu').textContent = waktuSekarang;

            const prodList = document.getElementById('tiket-produk-list');
            prodList.innerHTML = '';
            prod.forEach(p => {
                const item = document.createElement('span');
                item.className = "bg-blue-50 px-2 py-0.5 rounded text-[10px] border border-blue-100";
                item.textContent = p;
                prodList.appendChild(item);
            });

            generateQR(id);
            if (window.lucide) lucide.createIcons();
            window.scrollTo(0, 0);
        }

        function generateQR(id) {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            let urlBase = window.location.href.split('?')[0];
            const finalUrl = `${urlBase}?verify=${id}`;
            new QRCode(container, { text: finalUrl, width: 160, height: 160, colorDark : "#1e3a8a" });
        }

        function resetForm() { window.location.href = window.location.pathname; }

        function autoVerify(id) {
            const pesanan = getPesanan().find(p => p.id === id.toUpperCase());
            if (!pesanan) return;
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-verifikasi').classList.remove('hidden');
            pesananAktif = pesanan;
            document.getElementById('verifikasi-data').classList.remove('hidden');
            document.getElementById('v-id').textContent = pesanan.id;
            document.getElementById('v-nama').textContent = pesanan.nama;
            document.getElementById('v-no-atm').textContent = pesanan.no_atm;
            document.getElementById('v-kategori').textContent = pesanan.kategori;
            const prodContainer = document.getElementById('v-produk');
            prodContainer.innerHTML = '';
            pesanan.produkNama.forEach(n => { 
                const span = document.createElement('span'); 
                span.className = "bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold";
                span.textContent = n; 
                prodContainer.appendChild(span); 
            });
            if (window.lucide) lucide.createIcons();
        }

        function approvePesanan() {
            if(!pesananAktif) return;
            updateStatusPesanan(pesananAktif.id, 'Selesai');
            alert("Berhasil Diverifikasi!");
            window.location.href = window.location.pathname;
        }

        window.onload = () => {
            initDB();
            renderProduk(); 
            if (window.lucide) lucide.createIcons();
            const urlParams = new URLSearchParams(window.location.search);
            const vId = urlParams.get('verify');
            if (vId) autoVerify(vId);
        };
    </script>
</body>
</html>
