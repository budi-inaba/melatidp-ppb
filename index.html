<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PPB - Pendaftaran</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .error-msg {
            display: none;
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }
        /* Modal Backdrop Blur */
        #modal-overlay {
            backdrop-filter: blur(4px);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <!-- MODAL PERINGATAN (DI TENGAH LAYAR) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center fade-in">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2" id="modal-title">Data Tidak Valid</h3>
            <p class="text-gray-600 text-sm mb-6" id="modal-message">Mohon periksa kembali input Anda.</p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition active:scale-95 shadow-lg shadow-blue-200">
                Saya Mengerti
            </button>
        </div>
    </div>

    <nav class="bg-white shadow-md border-b-4 border-blue-600 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex flex-col items-center gap-1">
            <div class="h-10 flex items-center justify-center">
                <img src="logo-rptra.png" alt="Logo RPTRA" class="h-full w-auto object-contain" onerror="this.src='https://placehold.co/120x40/f3f4f6/3b82f6?text=LOGO+RPTRA';">
            </div>
            <div class="flex flex-col items-center text-center">
                <span class="font-extrabold text-xl tracking-tight text-blue-900 leading-tight">Sistem PPB Terpadu</span>
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">RPTRA Melati Duri Pulo</span>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- VIEW: PENDAFTARAN -->
        <div id="view-form" class="fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-gray-900">Formulir Pendaftaran</h1>
                    <p class="text-gray-500 text-sm">Program Pangan Bersubsidi</p>
                </div>

                <form id="form-pendaftaran" class="space-y-6" onsubmit="handlePendaftaran(event)">
                    <div class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h2 class="font-bold flex items-center gap-2 text-blue-600 border-b pb-2 text-sm uppercase">
                            <i data-lucide="user" class="w-4 h-4"></i> Informasi Identitas
                        </h2>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kelurahan Sesuai KK</label>
                            <input type="text" id="kelurahan" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama kelurahan">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. Kartu Keluarga (16 Digit)</label>
                            <input type="number" id="no_kk" required oninput="limitDigits(this, 16); validateInputLength(this, 16)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="317101XXXXXXXXXX">
                            <p id="error-no_kk" class="error-msg text-red-500 text-[10px] mt-1 hidden italic">Peringatan: Nomor KK harus tepat 16 digit.</p>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Nama Pengisi Form</label>
                            <input type="text" id="nama_pengisi" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama lengkap">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. KTP (16 Digit)</label>
                            <input type="number" id="nik" required oninput="limitDigits(this, 16); validateInputLength(this, 16)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="317101XXXXXXXXXX">
                            <p id="error-nik" class="error-msg text-red-500 text-[10px] mt-1 hidden italic">Peringatan: NIK/KTP harus tepat 16 digit.</p>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Nama Pemilik Kartu ATM</label>
                            <input type="text" id="nama" required oninput="validateLetters(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Sesuai nama di kartu">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">No. Kartu ATM (16 atau 18 Digit)</label>
                            <input type="number" id="no_atm" required oninput="limitDigits(this, 18); validateATM(this)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="6013XXXXXXXXXXXX">
                            <p id="error-no_atm" class="error-msg text-red-500 text-[10px] mt-1 hidden italic">Peringatan: Nomor ATM harus 16 atau 18 digit.</p>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kategori Penerima</label>
                            <select id="kategori_penerima" onchange="renderProduk()" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="" disabled selected>Pilih Kategori</option>
                                <option value="KJP">KJP (Kartu Jakarta Pintar)</option>
                                <option value="PJLP">PJLP (Penyedia Jasa Lainnya Perorangan)</option>
                                <option value="Kartu Lansia">Kartu Lansia Jakarta (KLJ)</option>
                                <option value="Kartu Disabilitas">Kartu Penyandang Disabilitas Jakarta (KPDJ)</option>
                                <option value="Dasawisma">Dasawisma</option>
                                <option value="KAJ">KAJ (Kartu Anak Jakarta)</option>
                                <option value="Kartu Pekerja">Kartu Pekerja Jakarta (KPJ)</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h2 class="font-bold flex items-center gap-2 text-green-600 border-b pb-2 text-sm uppercase">
                            <i data-lucide="shopping-bag" class="w-4 h-4"></i> Jenis Komoditas
                        </h2>
                        <div id="container-produk" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-blue-700 transition flex justify-center items-center gap-2 shadow-lg active:scale-95">
                        <i data-lucide="send" class="w-5 h-5"></i> Kirim Pendaftaran
                    </button>
                </form>
            </div>
        </div>

        <!-- VIEW: TIKET -->
        <div id="view-tiket" class="hidden fade-in max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 p-6 text-center border-b">
                    <img src="logo-rptra.png" alt="Logo RPTRA" class="h-8 w-auto mx-auto mb-2" onerror="this.src='https://placehold.co/80x30/f3f4f6/3b82f6?text=RPTRA';">
                    <h2 class="text-xl font-extrabold text-blue-900">Bukti Pendaftaran</h2>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">RPTRA Melati Duri Pulo</p>
                </div>
                
                <div class="p-6 text-center">
                    <div id="qrcode-container" class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100 flex justify-center"></div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mb-1 text-center">ID Transaksi</p>
                    <p id="tiket-id" class="text-3xl font-mono font-bold tracking-wider text-blue-700 mb-6 text-center">PPB-XXXX</p>
                    
                    <div class="text-left bg-gray-50 p-4 rounded-xl text-xs border border-gray-100 space-y-3 mb-6">
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Waktu Daftar</span> 
                            <span id="tiket-waktu" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Kelurahan</span> 
                            <span id="tiket-kelurahan" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">No. Kartu Keluarga</span> 
                            <span id="tiket-kk" class="font-bold font-mono text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Nama Pemilik Kartu ATM</span> 
                            <span id="tiket-nama" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Kategori Penerima</span> 
                            <span id="tiket-kategori" class="font-bold text-gray-800"></span>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Jenis Komoditas</span>
                            <div id="tiket-produk-list" class="flex flex-wrap gap-1 mt-1 font-bold text-blue-700 uppercase"></div>
                        </div>
                        <div class="flex flex-col border-b border-gray-200 pb-2">
                            <span class="text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Lokasi Pengambilan</span>
                            <div class="text-gray-800 leading-relaxed">
                                <p class="font-extrabold text-blue-900">RPTRA Melati Duri Pulo</p>
                                <p>Jl. Petojo Barat XI No. 5 RT. 012 RW. 001</p>
                                <p>Kelurahan Duri Pulo - Kecamatan Gambir</p>
                                <p>Jakarta Pusat</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="resetForm()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition text-sm">
                        Kembali ke Beranda
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Modal Logic
        function openModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function validateLetters(input) {
            input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
        }

        function limitDigits(input, max) {
            if (input.value.length > max) {
                input.value = input.value.slice(0, max);
            }
        }

        function validateInputLength(input, target) {
            const errorElement = document.getElementById('error-' + input.id);
            if (input.value.length > 0 && input.value.length !== target) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500', 'ring-1', 'ring-red-200');
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500', 'ring-1', 'ring-red-200');
            }
        }

        function validateATM(input) {
            const errorElement = document.getElementById('error-no_atm');
            const len = input.value.length;
            if (len > 0 && len !== 16 && len !== 18) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500', 'ring-1', 'ring-red-200');
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500', 'ring-1', 'ring-red-200');
            }
        }

        const KOMODITAS_LIST = [
            { id: 'ayam', nama: 'Ayam 1 ekor', harga: 'Rp 8.000' },
            { id: 'daging', nama: 'Daging Sapi 1Kg', harga: 'Rp 35.000' },
            { id: 'telur', nama: 'Telur Ayam 1 Tray', harga: 'Rp 10.000' },
            { id: 'beras', nama: 'Beras Premium 5Kg', harga: 'Rp 30.000' },
            { id: 'ikan', nama: 'Ikan Kembung 1Kg', harga: 'Rp 13.000' },
            { id: 'susu', nama: 'Susu UHT 1 Karton', harga: 'Rp 30.000' },
        ];

        function initDB() {
            if (!localStorage.getItem('db_pesanan')) localStorage.setItem('db_pesanan', JSON.stringify([]));
        }

        function getPesanan() { return JSON.parse(localStorage.getItem('db_pesanan')); }
        function savePesanan(data) {
            const p = getPesanan();
            p.push(data);
            localStorage.setItem('db_pesanan', JSON.stringify(p));
        }

        function renderProduk() {
            const container = document.getElementById('container-produk');
            const kategoriPenerima = document.getElementById('kategori_penerima').value;
            container.innerHTML = '';
            
            KOMODITAS_LIST.forEach(item => {
                if (item.id === 'susu' && kategoriPenerima && kategoriPenerima !== 'KJP') return;
                const div = document.createElement('div');
                div.className = `border-2 border-gray-100 rounded-xl p-4 flex items-center gap-4 transition bg-white hover:border-blue-400 cursor-pointer group`;
                div.innerHTML = `
                    <input type="checkbox" name="produk" value="${item.id}" class="w-5 h-5 rounded border-gray-300 text-blue-600">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800 text-sm group-hover:text-blue-700 transition uppercase">${item.nama}</p>
                        <p class="text-xs text-blue-500 font-bold">${item.harga}</p>
                    </div>`;
                div.onclick = (e) => { 
                    if(e.target.type !== 'checkbox') { 
                        const cb = div.querySelector('input'); 
                        cb.checked = !cb.checked; 
                    }
                };
                container.appendChild(div);
            });
        }

        function getFormattedDate() {
            const now = new Date();
            return now.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + 
                   now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace(/\./g, ':');
        }

        function handlePendaftaran(e) {
            e.preventDefault();
            const kel = document.getElementById('kelurahan').value;
            const nik = document.getElementById('nik').value;
            const no_kk = document.getElementById('no_kk').value;
            const nama = document.getElementById('nama').value;
            const no_atm = document.getElementById('no_atm').value;
            const kategori = document.getElementById('kategori_penerima').value;
            const nama_pengisi = document.getElementById('nama_pengisi').value;
            
            // Validasi Kritis menggunakan Modal Kustom
            if (no_kk.length < 16) {
                openModal("Nomor KK Tidak Valid", "Nomor Kartu Keluarga yang Anda masukkan kurang dari 16 digit. Silakan periksa kembali.");
                return;
            }

            if (nik.length < 16) {
                openModal("Nomor KTP Tidak Valid", "Nomor KTP (NIK) yang Anda masukkan kurang dari 16 digit. Silakan lengkapi data Anda.");
                return;
            }

            // Validasi Nomor ATM (16 atau 18)
            if (no_atm.length !== 16 && no_atm.length !== 18) {
                openModal("Nomor ATM Tidak Valid", "Nomor Kartu ATM harus berjumlah 16 atau 18 digit.");
                return;
            }

            const prod = Array.from(document.querySelectorAll('input[name="produk"]:checked')).map(c => {
                return KOMODITAS_LIST.find(k => k.id === c.value).nama;
            });

            if(prod.length === 0) {
                openModal("Komoditas Kosong", "Silakan pilih minimal satu jenis komoditas pangan.");
                return;
            }

            const id = `PPB-${Math.floor(1000 + Math.random() * 9000)}`;
            const waktuSekarang = getFormattedDate();
            
            savePesanan({ id, nik, no_kk, nama, no_atm, kategori, nama_pengisi, kelurahan: kel, produkNama: prod, status: 'Menunggu', waktu: waktuSekarang });

            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-tiket').classList.remove('hidden');
            
            // Render Data ke Tiket
            document.getElementById('tiket-id').textContent = id;
            document.getElementById('tiket-nama').textContent = nama;
            document.getElementById('tiket-kategori').textContent = kategori;
            document.getElementById('tiket-kk').textContent = no_kk;
            document.getElementById('tiket-kelurahan').textContent = kel;
            document.getElementById('tiket-waktu').textContent = waktuSekarang;

            const prodList = document.getElementById('tiket-produk-list');
            prodList.innerHTML = '';
            prod.forEach(p => {
                const item = document.createElement('span');
                item.className = "bg-blue-50 px-2 py-0.5 rounded text-[10px] border border-blue-100";
                item.textContent = p;
                prodList.appendChild(item);
            });

            generateQR(id);
            if (window.lucide) lucide.createIcons();
            window.scrollTo(0, 0);
        }

        function generateQR(id) {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            let urlBase = window.location.href.split('?')[0];
            const finalUrl = `${urlBase}?verify=${id}`;
            new QRCode(container, { text: finalUrl, width: 160, height: 160, colorDark : "#1e3a8a" });
        }

        function resetForm() { window.location.href = window.location.pathname; }

        window.onload = () => {
            initDB();
            renderProduk(); 
            if (window.lucide) lucide.createIcons();
        };
    </script>
</body>
</html>
